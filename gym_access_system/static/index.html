<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Monitoring Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        .box {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            cursor: pointer;
        }
        .real-time-logs {
            background-color: #90caf9; /* Light Blue */
            color: #000;
            width: 400px;
            height: 150px;
            overflow-y: auto; /* Enable scrolling for logs */
            white-space: pre-line; /* Maintain line breaks */
        }
        .people-graph {
            background-color: #f48fb1; /* Light Pink */
            color: #000;
            width: 400px;
            height: 150px;
        }
        .people-count {
            background-color: #a5d6a7; /* Light Green */
            color: #000;
            width: 200px;
        }
        .fan-control {
            background-color: #c5e1a5; /* Light Lime */
            color: #000;
            width: 200px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Gym Monitoring Dashboard</h1>
    <div class="container">
        <!-- Real-time Logs -->
        <div id="realTimeLogs" class="box real-time-logs">
            Vizualizare in timp real ale log-urilor persoanelor care intra si ies din sala
        </div>

        <!-- People Count and Fan ON/OFF -->
        <div style="display: flex; gap: 10px; justify-content: center;">
            <div id="peopleCount" class="box people-count">Numarul de persoane din sala in momentul curent: 0</div>
            <div id="fanStatus" class="box fan-control" onclick="toggleFan()">Fan OFF</div>
        </div>

        <!-- People Graph -->
        <div id="peopleGraph" class="box people-graph">
            Grafic de vizualizare al numarului de persoane din sala in functie de timpii de check in si check out
        </div>
    </div>

    <script>
        const realTimeLogs = document.getElementById('realTimeLogs');
        const peopleCount = document.getElementById('peopleCount');
        const fanStatus = document.getElementById('fanStatus');

        // Fetch people count from the server
        async function fetchPeopleCount() {
            try {
                const response = await fetch('/api/people_count');
                const data = await response.json();
                peopleCount.innerText = `Numarul de persoane din sala in momentul curent: ${data.people_count}`;
            } catch (error) {
                console.error("Error fetching people count:", error);
            }
        }

        // Fetch fan status from the server (Updated endpoint)
        async function fetchFanStatus() {
            try {
                const response = await fetch('/api/get_fan_status');  // Updated to new endpoint
                const data = await response.json();
                fanStatus.innerText = data.fan_on ? 'Fan ON' : 'Fan OFF';
                fanStatus.style.backgroundColor = data.fan_on ? '#81c784' : '#c5e1a5'; // Darker green when ON
            } catch (error) {
                console.error("Error controlling fan:", error);
            }
        }

        // Toggle fan status via the server and send the current status in the request body
        async function toggleFan() {
            try {
                const currentFanStatus = fanStatus.innerText === 'Fan OFF' ? false : true; // Determine current status

                // Send the toggle request to the server with the current fan status
                const response = await fetch('/api/toggle_fan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fan_on: !currentFanStatus }) // Toggle fan status
                });
                
                const data = await response.json();
                
                // Update the button text based on the fan status
                if (data.fan_on) {
                    fanStatus.innerText = 'Fan ON';
                    fanStatus.style.backgroundColor = '#81c784';  // Green when ON
                } else {
                    fanStatus.innerText = 'Fan OFF';
                    fanStatus.style.backgroundColor = '#c5e1a5';  // Light lime when OFF
                }
            } catch (error) {
                console.error("Error toggling fan:", error);
            }
        }

        // Fetch real-time logs from the server
        async function fetchRealTimeLogs() {
            try {
                const response = await fetch('/api/access_logs');
                const data = await response.json();
                if (data.logs && data.logs.length > 0) {
                    realTimeLogs.innerText = data.logs.join('\n'); // Display logs as a list
                } else {
                    realTimeLogs.innerText = "No logs available.";
                }
            } catch (error) {
                console.error("Error fetching logs:", error);
                realTimeLogs.innerText = "Error fetching logs.";
            }
        }

        // Periodically update the dashboard
        setInterval(() => {
            fetchPeopleCount();
            fetchFanStatus();
            fetchRealTimeLogs();
        }, 2000); // Update every 2 seconds

        // Initial load
        fetchPeopleCount();
        fetchFanStatus();
        fetchRealTimeLogs();
    </script>
</body>
</html>
